<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <title>My ideal BTRFS setup on Arch Linux | keyb0ardninja's blog</title><meta name="description" content="the pursuit of truth">
    <link rel="preload" href="/assets/js/runtime~app.d690f019.js" as="script"><link rel="preload" href="/assets/css/styles.49d2d103.css" as="style"><link rel="preload" href="/assets/js/812.42ea5ea4.js" as="script"><link rel="preload" href="/assets/js/app.84c33ab9.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.49d2d103.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">keyb0ardninja&#39;s blog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">My ideal BTRFS setup on Arch Linux</p><ul class=""><li><!--[--><a aria-current="page" href="/BTRFS.html#the-problem" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="The problem"><!--[--><!--]--> The problem <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/BTRFS.html#the-solution" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="The solution"><!--[--><!--]--> The solution <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/BTRFS.html#step-by-step-guide" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Step-by-Step Guide"><!--[--><!--]--> Step-by-Step Guide <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/BTRFS.html#efi-system-partition-esp-setup" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="EFI System Partition (ESP) setup"><!--[--><!--]--> EFI System Partition (ESP) setup <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/BTRFS.html#backup-efi-optional" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Backup /efi (OPTIONAL)"><!--[--><!--]--> Backup /efi (OPTIONAL) <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/BTRFS.html#luks2-setup" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="LUKS2 setup"><!--[--><!--]--> LUKS2 setup <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/BTRFS.html#avoid-entering-passphrase-twice-optional" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Avoid entering passphrase twice (OPTIONAL)"><!--[--><!--]--> Avoid entering passphrase twice (OPTIONAL) <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/BTRFS.html#grub-setup" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="GRUB setup"><!--[--><!--]--> GRUB setup <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/BTRFS.html#grub-btrfs-setup" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="grub-btrfs setup"><!--[--><!--]--> grub-btrfs setup <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/BTRFS.html#conclusion" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Conclusion"><!--[--><!--]--> Conclusion <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="my-ideal-btrfs-setup-on-arch-linux" tabindex="-1"><a class="header-anchor" href="#my-ideal-btrfs-setup-on-arch-linux" aria-hidden="true">#</a> My ideal BTRFS setup on Arch Linux</h1><p>In this post, I&#39;ll describe how I managed to fix some problems with my encrypted BTRFS (with snapper) setup in Arch Linux after some hit and trial. Although the venerable <a href="https://wiki.archlinux.org" target="_blank" rel="noopener noreferrer">Arch Wiki<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> has most of the information presented here, it had some missing pieces and the information in the wiki is scattered over many entries. I&#39;ve tried to compile everything into one cohesive piece here.</p><p>This post assumes you are already familiar with, and are (or will be) using:</p><ul><li>btrfs</li><li>cryptsetup (LUKS2)</li><li>UEFI</li><li>snapper</li><li>grub</li><li>Arch btw ðŸ˜‰</li></ul><div class="custom-container tip"><p class="custom-container-title">NOTE</p><p>GRUB, because only GRUB has support for this workflow. Check comparison table <a href="https://wiki.archlinux.org/title/Arch_boot_process#Feature_comparison" target="_blank" rel="noopener noreferrer">here<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</p></div><h2 id="the-problem" tabindex="-1"><a class="header-anchor" href="#the-problem" aria-hidden="true">#</a> The problem</h2><p>Until now, I was mounting the ESP (<em>EFI System Partition</em>) to <code>/boot</code>, which is quite common in Arch Linux. But this has some drawbacks:</p><ol><li><p>Each snapshot of the root subvolume wouldn&#39;t have its own copy of the kernel and initrd images (which are located inside <code>/boot</code>). This means that there is no guarantee that you will be able to boot a snapshot from a month ago, if your current kernel/initrd is not the same as the kernel/initrd that was being used when the snapshot was taken, especially if you&#39;ve made significant changes to <code>/etc/mkinitcpio.conf</code>.</p></li><li><p>If your system becomes unbootable after an upgrade due to a problem with the kernel, then you won&#39;t be able to boot an otherwise perfectly working old snapshot of your system.</p></li><li><p>If you want to maintain a twin system (while having the ability to modify the twin without worrying about messing up your main system), then the two systems should not share anything, including the kernels and initrd images.</p></li></ol><h2 id="the-solution" tabindex="-1"><a class="header-anchor" href="#the-solution" aria-hidden="true">#</a> The solution</h2><p>We simply need to keep <code>/boot</code> as a simple directory in the subvolume mounted at <code>/</code> i.e. don&#39;t mount anything to <code>/boot</code>. This will ensure that each snapshot has its own copy of the contents of <code>/boot</code> and wouldn&#39;t be sharing the same exact <code>/boot</code>, which they otherwise do when the ESP is mounted at <code>/boot</code>.</p><p>But for this to work, the EFI bootloader in the ESP needs to be able to read the kernel and initrd images from the BTRFS partition. Additionally, if the BTRFS partition is encrypted, then it will have to unlock the encrypted partition first and then read the BTRFS partition inside it.</p><p>Currently, only one bootloader has this capability: GRUB. (<a href="https://wiki.archlinux.org/title/Arch_boot_process#Feature_comparison" target="_blank" rel="noopener noreferrer">See here<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>)</p><h2 id="step-by-step-guide" tabindex="-1"><a class="header-anchor" href="#step-by-step-guide" aria-hidden="true">#</a> Step-by-Step Guide</h2><h3 id="efi-system-partition-esp-setup" tabindex="-1"><a class="header-anchor" href="#efi-system-partition-esp-setup" aria-hidden="true">#</a> EFI System Partition (ESP) setup</h3><p>We need to mount the ESP to <code>/efi</code> instead of <code>/boot</code>.</p><ol><li><p>Edit <code>/etc/fstab</code> and change the mount point of the ESP for <code>/boot</code> to <code>/efi</code>.</p></li><li><p>Unmount the ESP currently mounted at <code>/boot</code> and mount it to <code>/efi</code>, like this:</p></li></ol><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">umount</span> /boot
$ <span class="token function">sudo</span> <span class="token function">mkdir</span> /efi
$ <span class="token function">sudo</span> <span class="token function">mount</span> /efi
</code></pre></div><p>At this point, your <code>/boot</code> directory should be empty. To populate it with the kernel and initrd images, reinstall the <code>linux</code> package (or whatever kernel you use) and the <a href="https://wiki.archlinux.org/title/Microcode" target="_blank" rel="noopener noreferrer">microcode<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> package, like this:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> pacman -S linux intel-ucode <span class="token comment">#use amd-ucode for AMD CPU</span>
</code></pre></div><p><code>/boot</code> should look something like this now:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">ls</span> /boot
initramfs-linux-fallback.img  initramfs-linux.img  intel-ucode.img  vmlinuz-linux
</code></pre></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>You should clean up the old version of these files now present in <code>/efi</code> only after going through this entire post and verifying that everything works.</p></div><p>If you were using the <code>50-bootbackup.hook</code> pacman hook <a href="https://wiki.archlinux.org/title/Snapper#Backup_non-Btrfs_boot_partition_on_pacman_transactions" target="_blank" rel="noopener noreferrer">described in the Arch Wiki<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>, you no longer need it, and you should remove it:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">rm</span> /etc/pacman.d/hooks/50-bootbackup.hook
</code></pre></div><p>Instead, you might want to back up the ESP mounted to <code>/efi</code>. The procedure for doing so is described next.</p><h4 id="backup-efi-optional" tabindex="-1"><a class="header-anchor" href="#backup-efi-optional" aria-hidden="true">#</a> Backup <code>/efi</code> (OPTIONAL)</h4><p>Because the ESP is outside BTRFS, its content will not be part of snapshots. To keep a synced copy inside BTRFS root subvolume (in <code>/.esp.backup</code>), use the following systemd units (you need both the files):</p><hr><p><code>/etc/systemd/system/espbackup.path</code></p><div class="language-ini ext-ini"><pre class="language-ini"><code><span class="token header"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">Monitors for changes in ESP</span>
<span class="token key attr-name">DefaultDependencies</span><span class="token punctuation">=</span><span class="token value attr-value">no</span>
<span class="token key attr-name">After</span><span class="token punctuation">=</span><span class="token value attr-value">efi.mount</span>
<span class="token key attr-name">BindsTo</span><span class="token punctuation">=</span><span class="token value attr-value">efi.mount</span>

<span class="token header"><span class="token punctuation">[</span><span class="token section-name selector">Path</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">PathModified</span><span class="token punctuation">=</span><span class="token value attr-value">/efi</span>

<span class="token header"><span class="token punctuation">[</span><span class="token section-name selector">Install</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">WantedBy</span><span class="token punctuation">=</span><span class="token value attr-value">efi.mount</span>
</code></pre></div><div class="custom-container tip"><p class="custom-container-title">NOTE</p><p>Replace <code>efi.mount</code> with the name of the systemd service that mounts <code>/efi</code>. Run <code>systemctl list-units -t mount</code> to find out.</p></div><hr><p><code>/etc/systemd/system/espbackup.service</code></p><div class="language-ini ext-ini"><pre class="language-ini"><code><span class="token header"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">Sync ESP</span>

<span class="token header"><span class="token punctuation">[</span><span class="token section-name selector">Service</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Type</span><span class="token punctuation">=</span><span class="token value attr-value">oneshot</span>
<span class="token comment"># Set the possible paths for `rsync`</span>
<span class="token key attr-name">Environment</span><span class="token punctuation">=</span><span class="token value attr-value">&quot;<span class="token inner-value">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span>&quot;</span>
<span class="token comment"># Sync directories</span>
<span class="token key attr-name">ExecStart</span><span class="token punctuation">=</span><span class="token value attr-value">rsync -a --delete /efi/ /.efi.backup</span>
</code></pre></div><hr><p>Now, enable and start it with:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> --now espbackup.path
</code></pre></div><h3 id="luks2-setup" tabindex="-1"><a class="header-anchor" href="#luks2-setup" aria-hidden="true">#</a> LUKS2 setup</h3><div class="custom-container danger"><p class="custom-container-title">WARNING</p><p>If the header of a LUKS encrypted partition gets destroyed, you will not be able to decrypt your data. Before proceeding with this section, make sure that you back up the header of your current LUKS partition and store it in a safe location (which must be <em>outside</em> that encrypted partition itself, obviously). <a href="https://wiki.archlinux.org/title/Dm-crypt/Device_encryption#Backup_using_cryptsetup" target="_blank" rel="noopener noreferrer">Consult the Arch Wiki for this<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</p></div><p>If <code>/dev/sdXN</code> is your LUKS2 partition, check current keyslots with:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> cryptsetup luksDump /dev/sdXN
</code></pre></div><p>Note which keyslot is being used. If the PBKDF of your current key is not <code>pbkdf2</code>, then you have to convert it to <code>pbkdf2</code> because in the current version of GRUB, <a href="https://git.savannah.gnu.org/cgit/grub.git/commit/?id=365e0cc3e7e44151c14dd29514c2f870b49f9755" target="_blank" rel="noopener noreferrer">only the <code>pbkdf2</code> key derival function is supported<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</p><p>The PBKDF algorithm can be changed for the existing key with (replace <em>N</em> with the actual keyslot number, and <code>/dev/sdXN</code> with your LUKS2 partition):</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> cryptsetup luksConvertKey --key-slot N --pbkdf pbkdf2 /dev/sdXN
</code></pre></div><div class="custom-container tip"><p class="custom-container-title">NOTE</p><p>The decryption of GRUB is quite slow. You can make it faster by changing the <code>iter-time</code> parameter of the key. Just add <code>--iter-time XXXX</code> to the command above.</p><p>See <a href="https://unix.stackexchange.com/questions/369414/grub-takes-too-long-to-unlock-the-encrypted-boot-partition" target="_blank" rel="noopener noreferrer">here<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> for more info. I used a value of <code>500</code> (default is <code>2000</code>), but do your own research on this, because reducing the <code>iter-time</code> will reduce security.</p></div><div class="custom-container tip"><p class="custom-container-title">NOTE</p><p>After verifying that everything works, you might want to create another backup of your new LUKS header</p></div><h4 id="avoid-entering-passphrase-twice-optional" tabindex="-1"><a class="header-anchor" href="#avoid-entering-passphrase-twice-optional" aria-hidden="true">#</a> Avoid entering passphrase twice (OPTIONAL)</h4><p>You will be prompted twice for a passphrase: first, for GRUB to unlock and access <code>/boot</code> in early boot, and second, to unlock the root filesystem itself as implemented by the initramfs. You can use a keyfile to avoid this.</p><p>Do the following to generate a keyfile, give it suitable permissions and add it as a LUKS key:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">dd</span> <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">512</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/random <span class="token assign-left variable">of</span><span class="token operator">=</span>/crypto_keyfile.bin <span class="token assign-left variable">iflag</span><span class="token operator">=</span>fullblock
$ <span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">600</span> /crypto_keyfile.bin
$ <span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">600</span> /boot/initramfs-linux*
$ <span class="token function">sudo</span> cryptsetup luksAddKey /dev/sdXN /crypto_keyfile.bin
</code></pre></div><p>where <code>/dev/sdXN</code> is your LUKS2 partition.</p><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>If you&#39;re using the <code>encrypt</code> hook in <code>/etc/mkinitcpio.conf</code>, the keyfile must be named and located <em>exactly</em> in <code>/crypto_keyfile.bin</code>, otherwise you will need extra configuration.</p><p>If you&#39;re using <code>sd-encrypt</code> instead, consult the Arch Wiki about configuring the keyfile, because I&#39;ve never tried <code>sd-encrypt</code>.</p></div><p>(<a href="https://wiki.archlinux.org/title/Dm-crypt/Device_encryption#With_a_keyfile_embedded_in_the_initramfs" target="_blank" rel="noopener noreferrer">Source: Arch Wiki<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>)</p><p>Include the key in <code>/etc/mkinitcpio.conf</code>&#39;s <code>FILES</code> array:</p><div class="language-text ext-text"><pre class="language-text"><code>FILES=(/crypto_keyfile.bin)
</code></pre></div><p>Regenerate the initramfs:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> mkinitcpio -P
</code></pre></div><div class="custom-container tip"><p class="custom-container-title">NOTE</p><p>The keyfile doesn&#39;t need to be <code>pbkdf2</code></p></div><h3 id="grub-setup" tabindex="-1"><a class="header-anchor" href="#grub-setup" aria-hidden="true">#</a> GRUB setup</h3><p>Install the <a href="https://archlinux.org/packages/core/x86_64/grub/" target="_blank" rel="noopener noreferrer"><code>grub</code><span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> package if not already installed:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> pacman -S grub
</code></pre></div><p>Edit <code>/etc/default/grub</code> and add <code>luks2</code> to <code>GRUB_PRELOAD_MODULES</code>, like this:</p><div class="language-text ext-text"><pre class="language-text"><code>GRUB_PRELOAD_MODULES=&quot;part_gpt part_msdos luks2&quot;
</code></pre></div><p>Edit the other configurations in <code>/etc/default/grub</code> as you normally do.</p><p>Create the file <code>/etc/grub.d/01_header</code> with the following content:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token shebang important">#! /bin/sh</span>

<span class="token comment"># replace d36b433dfce44d91b7cef4f37c2a3bdd with UUID of your LUKS2 partition</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;cryptomount -u d36b433dfce44d91b7cef4f37c2a3bdd&quot;</span>
</code></pre></div><div class="custom-container tip"><p class="custom-container-title">NOTE</p><p>If the UUID of your LUKS2 partition is <code>d36b433d-fce4-4d91-b7ce-f4f37c2a3bdd</code>, you should remove the dashes, like this: <code>d36b433dfce44d91b7cef4f37c2a3bdd</code>. (<a href="https://www.gnu.org/software/grub/manual/grub/html_node/cryptomount.html#cryptomount" target="_blank" rel="noopener noreferrer">Source<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>).</p></div><p>(This is much simpler than the process described <a href="https://wiki.archlinux.org/title/GRUB#LUKS2" target="_blank" rel="noopener noreferrer">here<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> in the Arch Wiki.)</p><p>Now register GRUB in the ESP:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> grub-install --target<span class="token operator">=</span>x86_64-efi --efi-directory<span class="token operator">=</span>/efi --boot-directory<span class="token operator">=</span>/efi --bootloader-id<span class="token operator">=</span>GRUB
</code></pre></div><p>The command above should create:</p><ul><li>the file <code>/efi/EFI/GRUB/grubx64.efi</code></li><li>the directory <code>/efi/grub</code></li><li>an entry in the UEFI bootloader called <code>GRUB</code>, which you can verify by running <code>efibootmgr</code></li></ul><p>Finally, generate the GRUB configuration:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">grub-mkconfig</span> -o /efi/grub/grub.cfg
</code></pre></div><h4 id="grub-btrfs-setup" tabindex="-1"><a class="header-anchor" href="#grub-btrfs-setup" aria-hidden="true">#</a> <code>grub-btrfs</code> setup</h4><p>Install <a href="https://archlinux.org/packages/community/any/grub-btrfs/" target="_blank" rel="noopener noreferrer"><code>grub-btrfs</code><span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> pacman -S grub-btrfs
</code></pre></div><p>The configuration file for <code>grub-btrfs</code> is <code>/etc/default/grub-btrfs/config</code>. Change the following value in <code>/etc/default/grub-btrfs/config</code>:</p><div class="language-text ext-text"><pre class="language-text"><code>GRUB_BTRFS_GRUB_DIRNAME=&quot;/efi/grub&quot;
</code></pre></div><p>For entries to be automatically added to the GRUB menu whenever a snapshot is made or deleted, mount your subvolume which contains snapshots to <code>/.snapshots</code> (ideally you should have an entry for this in <code>/etc/fstab</code>), and run:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> --now grub-btrfs.path
</code></pre></div><p><code>grub-btrfs.path</code> is a systemd unit which automatically (re)generates <code>/efi/grub/grub-btrfs.cfg</code> whenever a modification happens in <code>/.snapshots</code>.</p><h5 id="booting-read-only-snapshots" tabindex="-1"><a class="header-anchor" href="#booting-read-only-snapshots" aria-hidden="true">#</a> Booting read-only snapshots</h5><blockquote><p>Booting on a snapshot in read-only mode can be tricky. An elegant way is to boot this snapshot using overlayfs (included in the kernel â‰¥ 3.18).</p></blockquote><blockquote><p>Using overlayfs, the booted snapshot will behave like a live-cd in non-persistent mode. The snapshot will not be modified, the system will be able to boot correctly, because a writeable folder will be included in the ram.</p></blockquote><p>(<a href="https://github.com/Antynea/grub-btrfs/blob/master/initramfs/readme.md" target="_blank" rel="noopener noreferrer">Source<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>)</p><p>Edit <code>/etc/mkinitcpio.conf</code> and add the hook <code>grub-btrfs-overlayfs</code> at the end of the line <code>HOOKS</code>. For example:</p><div class="language-text ext-text"><pre class="language-text"><code>HOOKS=(base udev autodetect modconf block filesystems keyboard fsck grub-btrfs-overlayfs)
</code></pre></div><div class="custom-container danger"><p class="custom-container-title">WARNING</p><p>Do not copy-paste the above line. You should only add <code>grub-btrfs-overlayfs</code> to the pre-existing line in the file.</p></div><p>Finally regenerate the initramfs.</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> mkinitcpio -P
</code></pre></div><h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion" aria-hidden="true">#</a> Conclusion</h2><p>If everything works as intended after rebooting, you should delete the following files:</p><div class="language-text ext-text"><pre class="language-text"><code>/efi/initramfs-linux-fallback.img
/efi/initramfs-linux.img
/efi/intel-ucode.img
/efi/vmlinuz-linux
</code></pre></div><p>Now the ESP (mounted to <code>/efi</code>) should look something like this:</p><div class="language-text ext-text"><pre class="language-text"><code>/efi
â”œâ”€â”€ EFI
â”‚   â”œâ”€â”€ BOOT
â”‚   â”‚   â””â”€â”€ BOOTX64.EFI
â”‚   â””â”€â”€ GRUB
â”‚       â””â”€â”€ grubx64.efi
â””â”€â”€ grub
    â”œâ”€â”€ fonts
    â”œâ”€â”€ grub-btrfs.cfg
    â”œâ”€â”€ grub.cfg
    â”œâ”€â”€ grubenv
    â”œâ”€â”€ locale
    â”œâ”€â”€ themes
    â””â”€â”€ x86_64-efi
</code></pre></div><p>Quite clean âœ¨, eh?</p><p>You can verify that each snapshot is using its own copy of the kernel and initrd images by inspecting the entries generated in <code>/efi/grub/grub-btrfs.cfg</code>. Notice the lines starting with <code>linux</code> and <code>initrd</code> for the various entries, and you will observe that each entry is using its own <code>/boot</code> directory for booting.</p><p>In the future, I&#39;ll describe how I can now effortlessly create and manage a twin system with this setup. Thanks for reading!</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">11/17/2021, 7:24:01 PM</span></div><div class="meta-item contributors"><span class="meta-item-label">Author: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: d_debnath@outlook.com">D. Debnath</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.d690f019.js" defer></script><script src="/assets/js/812.42ea5ea4.js" defer></script><script src="/assets/js/app.84c33ab9.js" defer></script>
  </body>
</html>
